<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Oxygen Stations Map</title>

    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"
    />

    <style>
      #map {
        height: 100vh;
        width: 100%;
      }

      .icon-wrap {
        position: relative;
        display: flex;
        justify-content: center;
        align-items: center;
        border-radius: 50%;
        cursor: pointer;
        color: white;
      }

      .hover-label {
        position: absolute;
        bottom: 48px;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(0, 0, 0, 0.8);
        color: #fff;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 12px;
        font-weight: bold;
        white-space: nowrap;
        display: none;
        pointer-events: none;
      }
    </style>
  </head>
  <body>
    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
      /* ================= MAP ================= */
      const map = L.map("map").setView(
        [7.262542526983923, 38.65560105912916],
        9.4
      );

      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        maxZoom: 19,
      }).addTo(map);

      /* ============ COLORS ============ */
      const STATION_COLOR = "#1abc9c"; // teal
      const USER_COLOR = "#3498db"; // blue
      const ROUTE_COLOR = "#8e44ad"; // purple
      const CIRCLE_COLOR = "#48c9b0"; // aqua

      let activeCircle = null;
      let activeRoute = null;

      /* ============ HARDCODED DATA ============ */
      const data = {
        fuel_stations: [
          {
            name: "Shashemene Comprehensive Specialized Hospital",
            lat: 7.26252124146018,
            lon: 38.65547231310751,
            grouped_stations: [
              {
                name: "Arsi Negele Primary Hospital",
                lat: 7.376401132661742,
                lon: 38.67299541010689,
              },
              {
                name: "Asella Referral and Teaching Hospital",
                lat: 7.969279669521352,
                lon: 39.13147807927722,
              },
              {
                name: "Batu General Hospital",
                lat: 7.927903986537142,
                lon: 38.70461995228746,
              },
              {
                name: "Bokoji Primary Hospital",
                lat: 7.544270344223446,
                lon: 39.25383627927203,
              },
              {
                name: "Chilalo Shade Hospital",
                lat: 7.961569923548104,
                lon: 39.134024882515575,
              },
              {
                name: "Dodola General Hospital",
                lat: 6.978903739727008,
                lon: 39.18977305217311,
              },
              {
                name: "Gambo General Hospital",
                lat: 7.306033684811289,
                lon: 38.81529872344484,
              },
              {
                name: "Kersa Primary Hospital",
                lat: 7.517654771862737,
                lon: 38.98370865820653,
              },
              {
                name: "Kokosa Primary Hospital",
                lat: 6.75871524983558,
                lon: 38.806114146168554,
              },
              {
                name: "Negele Arsi General Hospital & Medical College",
                lat: 7.362705337464291,
                lon: 38.66647406405968,
              },
            ],
          },
        ],
      };

      /* ============ ICON FUNCTIONS ============ */
      function stationIcon(name) {
        return L.divIcon({
          html: `
      <div class="icon-wrap" style="background:${STATION_COLOR};width:42px;height:42px;">
        <i class="fas fa-lungs fa-lg"></i>
        <div class="hover-label">${name}</div>
      </div>
    `,
          className: "",
          iconSize: [42, 42],
          iconAnchor: [21, 42],
        });
      }

      function userIcon(name) {
        return L.divIcon({
          html: `
      <div class="icon-wrap" style="background:${USER_COLOR};width:22px;height:22px;">
        <i class="fas fa-hospital fa-xs"></i>
        <div class="hover-label">${name}</div>
      </div>
    `,
          className: "",
          iconSize: [22, 22],
          iconAnchor: [11, 22],
        });
      }

      /* ============ HOVER HANDLER ============ */
      function bindHover(marker) {
        marker.on("mouseover", (e) => {
          const label = e.target._icon.querySelector(".hover-label");
          if (label) label.style.display = "block";
        });
        marker.on("mouseout", (e) => {
          const label = e.target._icon.querySelector(".hover-label");
          if (label) label.style.display = "none";
        });
      }

      /* ============ RENDER DATA ============ */
      data.fuel_stations.forEach((station) => {
        const stationMarker = L.marker([station.lat, station.lon], {
          icon: stationIcon(station.name),
        }).addTo(map);

        bindHover(stationMarker);

        station.grouped_stations.forEach((user) => {
          const userMarker = L.marker([user.lat, user.lon], {
            icon: userIcon(user.name),
          }).addTo(map);

          bindHover(userMarker);

          userMarker.on("click", async () => {
            if (activeRoute) map.removeLayer(activeRoute);

            const url = `https://router.project-osrm.org/route/v1/driving/${user.lon},${user.lat};${station.lon},${station.lat}?overview=full&geometries=geojson`;

            const res = await fetch(url);
            const json = await res.json();

            if (json.routes.length) {
              const route = json.routes[0];
              const km = (route.distance / 1000).toFixed(1);

              activeRoute = L.geoJSON(route.geometry, {
                style: {
                  color: ROUTE_COLOR,
                  weight: 5,
                  opacity: 0.85,
                  dashArray: "8,6",
                },
              }).addTo(map);

              map.fitBounds(activeRoute.getBounds(), { padding: [40, 40] });
              userMarker.bindPopup(`ðŸš— ${km} km driving distance`).openPopup();
            }
          });
        });

        stationMarker.on("click", () => {
          if (activeCircle) {
            map.removeLayer(activeCircle);
            activeCircle = null;
          } else {
            activeCircle = L.circle([station.lat, station.lon], {
              radius: 100000,
              color: CIRCLE_COLOR,
              fillColor: CIRCLE_COLOR,
              fillOpacity: 0.25,
              weight: 2,
              dashArray: "6,8",
            }).addTo(map);
          }
        });
      });
    </script>
  </body>
</html>
